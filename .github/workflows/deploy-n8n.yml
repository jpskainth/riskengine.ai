name: Deploy workflow to self-hosted n8n

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy n8n workflows
        env:
          N8N_HOST: ${{ secrets.N8N_HOST }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${N8N_HOST:-}" ] || [ -z "${N8N_API_KEY:-}" ]; then
            echo "Missing required secrets: N8N_HOST and/or N8N_API_KEY" >&2
            exit 1
          fi
          WORKFLOW_DIR="n8n-workflows/workflows"
          if [ ! -d "$WORKFLOW_DIR" ]; then
            echo "Workflows directory not found, creating: $WORKFLOW_DIR"
            mkdir -p "$WORKFLOW_DIR"
          fi

          # exit early if no JSON workflow files
          shopt -s nullglob || true
          files=("$WORKFLOW_DIR"/*.json)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No workflow JSON files found in $WORKFLOW_DIR; nothing to deploy."
            exit 0
          fi

          failures=0
          for file in "$WORKFLOW_DIR"/*.json; do
            [ -e "$file" ] || continue
            echo "Deploying $file"
            success=0
            endpoints=("/rest/workflows/import" "/workflows/import" "/workflows")
            for endpoint in "${endpoints[@]}"; do
              base_url="${N8N_HOST%/}$endpoint"

              echo "Trying JSON POST with Authorization: Bearer to $base_url"
              http_code=$(curl -sS -o /dev/null -w "%{http_code}" -X POST "$base_url" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $N8N_API_KEY" \
                --data-binary @"$file" || true)
              if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
                echo "Deployed $file to $base_url (HTTP $http_code)"
                success=1
                break
              fi

              echo "Trying JSON POST with X-N8N-API-KEY to $base_url"
              http_code=$(curl -sS -o /dev/null -w "%{http_code}" -X POST "$base_url" \
                -H "Content-Type: application/json" \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                --data-binary @"$file" || true)
              if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
                echo "Deployed $file to $base_url (HTTP $http_code)"
                success=1
                break
              fi

              echo "Trying multipart/form-data upload with X-N8N-API-KEY to $base_url"
              http_code=$(curl -sS -o /dev/null -w "%{http_code}" -X POST "$base_url" \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -F "file=@$file" || true)
              if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
                echo "Deployed $file to $base_url (HTTP $http_code)"
                success=1
                break
              fi

              echo "Attempt to $base_url returned HTTP $http_code"
            done

            if [ "$success" -ne 1 ]; then
              echo "Failed to deploy $file" >&2
              failures=$((failures+1))
            fi
          done
          if [ "$failures" -ne 0 ]; then
            echo "Deployment completed with $failures failures" >&2
            exit 2
          fi
          echo "All workflows deployed successfully"